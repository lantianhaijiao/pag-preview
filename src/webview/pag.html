<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta content="telephone=no" name="format-detection" />
    <meta content="email=no" name="format-detection" />
    <title>Pag Preview</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        border: 0;
      }
      body {
        padding: 0 !important;
      }
      .pag-player {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
        padding: 20px;
        box-sizing: border-box;
      }
      .pag-canvas {
        width: 50vw;
        height: 50vh;
        display: block;
      }
      .button-container {
        position: fixed;
        left: 0;
        right: 0;
        margin: 0 auto;
        bottom: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .pag-btn {
        width: 34px;
        height: 34px;
        border-radius: 5px;
        margin: 4px;
        border: 1px solid #909090;
      }
      .pag-btn-1 {
        background-color: #000;
      }
      .pag-btn-2 {
        background-color: #fff;
      }
      .pag-btn-3 {
        background-color: #00bcd3;
      }
      .pag-play {
        width: 100px;
        position: fixed;
        top: 20px;
        right: 20px;
        border: 1px solid #005ad9;
        background-color: #005ad9;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0 16px;
        height: 48px;
        line-height: 48px;
        border-radius: 8px;
        text-align: center;
        font-size: 18px;
      }
      #animation-info-box {
        position: fixed;
        background-color: rgba(0, 0, 0, 0.5);
        width: 200px;
        top: 0;
        left: 0;
        color: rgba(255, 255, 255, 0.8);
        font-size: 11px;
        padding: 10px;
        min-height: 50px;
        border-radius: 2px;
      }
      #animation-info-box span {
        display: inline-block;
        min-width: 60px;
      }
      #animationSelector {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px 30px 8px 10px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
      }

      #animationSelector:hover {
        border-color: #999;
      }

      #animationSelector:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }

      /* 选项样式 */
      #animationSelector option {
        background-color: #fff;
        color: #333;
      }

      #animationSelector option:hover {
        background-color: #f0f0f0;
      }
      .sdk-select{
        display: flex;
        align-items: center;
        margin: 0 10px;
      }
      .sdk-select span{
        background-color: #fff;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        font-size: 12px;
        padding: 0 5px;
        margin: 0 2px;
      }
      .file-size span, .sdk span{
        min-width: 60px;
      }
    </style>
  </head>
  <body>
    <div class="pag-player">
      <button onclick="playToggle()" class="pag-play">pause</button>
      <canvas class="pag-canvas"></canvas>
    </div>
    <div id="animation-info-box">
      <h3>PAG信息</h3>
      <div id="animation-info"></div>
      <div class="file-size"><span>size: </span><strong></strong></div>
      <div class="sdk"><span>sdk: </span><strong></strong></div>
    </div>
    <div class="button-container">
      <div class="pag-btn pag-btn-1" onclick="changeBg(1)"></div>
      <div class="pag-btn pag-btn-2" onclick="changeBg(2)"></div>
      <div class="pag-btn pag-btn-3" onclick="changeBg(3)"></div>
      <div class="sdk-select">
        <span>sdk:</span>
        <select id="animationSelector">
          <option value="pag">pag</option>
          <option value="pag-lite">pag-lite</option>
        </select>
      </div>
    </div>
    <script src="./libpag-lite.min.js"></script>
    <script>
      const vscode = acquireVsCodeApi();
      // 监听来自扩展的消息
      let url = "";
      var selectedLibrary = "pag";
      window.addEventListener("message", async (event) => {
        const message = event.data;
        if (message.type === "loadFile") {
          url = message.fileUri;
          if (!url) return;
          console.log('first', selectedLibrary);
          sdkChange(selectedLibrary);
          sdkHandle({
            scriptUrl: getScriptUrl(),
            currentLibrary: selectedLibrary
          });
        } else if (message.type === "fileSize") {
          console.log('');
          fileSize(message.size);
        } else if (message.command === "initLibrary") {
          const library = message.library;
          const scriptUrl = message.scriptUrl;
          // 清理之前的状态
          if (pagView) {
            try {
              await pagView.destroy();
            } catch (error) {
              console.error("销毁 pagView 时出错:", error);
            }
            pagView = null;
          }
          url = message.fileUri;
          selector.value = library;
          sdkChange(library);
          sdkHandle({
            scriptUrl: scriptUrl,
            currentLibrary: library
          });
        }
      });
      const fileSizeEle = document.querySelector(".file-size strong");
      function fileSize(size) {
        fileSizeEle.innerText = size;
      }
      const sdkEl = document.querySelector('.sdk strong');
      function sdkChange(val) {
        sdkEl.innerText = val;
      }
      var currentScript; // pag/pag-lite
      const originalCanvas = document.getElementsByClassName('pag-canvas')[0];
      var pagView;

      async function loadPag(url) {
        return fetch(url).then((response) => response.arrayBuffer());
      }
      // 监听选择事件
      var selector = document.getElementById("animationSelector");
      selector.addEventListener("change", (event) => {
        const value = event.target.value;
        selectedLibrary = value;
        switchLibrary();
      });
      const infoDiv = document.getElementById("animation-info");
      function updateInfo(info) {
        infoDiv.innerHTML = `
          <div class='item'><span>width: </span>${info.width}</div>
          <div class='item'><span>height: </span>${info.height}</div>
          <div class='item'><span>frames: </span>${Math.floor(
            info.frameCount
          )}</div>
          <div class='item'><span>frameRate: </span>${info.frameRate}</div>
          <div class='item'><span>duration: </span>${info.duration}</div>
        `;
      }
      function getScriptUrl() {
        return selectedLibrary === "pag"
          ? "./libpag.min.js"
          : "./libpag-lite.min.js";
      }

      async function switchLibrary() {
        selectedLibrary =
          document.getElementById("animationSelector").value;
        vscode.postMessage({
          command: "refreshPage",
          library: selectedLibrary,
        });
      }
      async function sdkHandle({
        scriptUrl,
        currentLibrary
      }) {
        const script = document.createElement("script");
        script.src = scriptUrl;
        document.head.appendChild(script);
        const canvas = document.getElementsByClassName('pag-canvas')[0];
        script.onload = async () => {
          if (!url) return;
          if (currentLibrary === "pag") {
            await pagInit(url, canvas);
          } else {
            await pagLiteInit(url, canvas);
          }
        };
      }

      async function pagInit(url, canvas) {
        const PAG = await window.libpag.PAGInit();
        const buffer = await loadPag(url);
        const pagFile = await PAG.PAGFile.load(buffer);
        canvas.width = pagFile.width();
        canvas.height = pagFile.height();

        pagView = await PAG.PAGView.init(pagFile, canvas);
        pagView.setRepeatCount(0);
        console.log("-----pag-----", pagView);
        await pagView.play();
        const duration = pagView.duration() / 1000 / 1000;
        // console.table({
        //   帧率: pagView.frameRate,
        //   总帧数: pagView.frameRate * duration,
        //   动画时长: duration,
        //   宽度: pagFile.width(),
        //   高度: pagFile.height(),
        // });
        updateInfo({
          width: pagFile.width(),
          height: pagFile.height(),
          duration: duration,
          frameRate: pagView.frameRate,
          frameCount: pagView.frameRate * duration,
        });
      }

      async function pagLiteInit(url, canvas) {
        const PAGView = libpag.PAGView;
        const types = libpag.types;
        const renderingMode = types.RenderingMode.WebGL;
        const initPag = async (src) => {
          const pagBuffer = await loadPag(src).catch((err) =>
            console.warn(err)
          );
          if (!pagBuffer) {
            console.log("onError");
            return;
          }

          pagView = await PAGView.init(pagBuffer, canvas, {
            renderingMode:
              renderingMode == "webgl"
                ? types.RenderingMode.WebGL
                : types.RenderingMode.Canvas2D,
            useScale: true,
          });
          pagView.setRepeatCount(0);
          await pagView.play();
          console.log("-----pag-lite-----", pagView);
          // console.table({
          //   帧率: pagView.videoSequence.frameRate,
          //   总帧数: pagView.videoSequence.frameCount,
          //   动画时长: pagView.videoReader._duration,
          //   宽度: pagView.videoSequence.width,
          //   高度: pagView.videoSequence.height,
          // });
          updateInfo({
            width: pagView.videoSequence.width,
            height: pagView.videoSequence.height,
            duration: pagView.videoReader._duration,
            frameRate: pagView.videoSequence.frameRate,
            frameCount: pagView.videoSequence.frameCount,
          });
        };
        await initPag(url).catch((err) => {
          console.log("onError", err);
          vscode.postMessage({
            command: "alert",
            text: `Unable to play: ${err.message}; \n You can click next to the color to switch to pag sdk for playback`,
          });
        });
      }

      function play() {
        pagView.play();
      }
      function pause() {
        pagView.pause();
      }
      function destroy() {
        pagView.destroy();
      }
      const pagPlayer = document.getElementsByClassName('pag-player')[0];
      const colors = {
        1: "#000",
        2: "#FFF",
        3: "#00bcd3",
      };
      let playStatus = true;
      const playRef = document.getElementsByClassName('pag-play')[0];
      function playToggle() {
        if (playStatus) {
          pause();
          playRef.innerText = "play";
        } else {
          play();
          playRef.innerText = "pause";
        }
        playStatus = !playStatus;
      }
      function changeBg(type) {
        pagPlayer.style.backgroundColor = colors[type];
      }
    </script>
  </body>
</html>
